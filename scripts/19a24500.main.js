"use strict";!function(){var a=window.caro_game||{};window.caro_game=a;var b=9,c=function(a){return{y:Math.floor(a/b),x:a%b}},d=function(a,c){return c*b+a},e=function(a,b){var c=[],d=[];return _.each(a,function(e,f){var g=b(e);g?(d.length>0&&(c.push(d),d=[]),d.push(e)):d.push(e),f===a.length-1&&c.push(d)}),c},f=function(a,b){var c,d=[],e=[];return _.each(a,function(f,g){var h=b(f);h===c||0===g?e.push(f):(d.push(e),e=[f]),g===a.length-1&&d.push(e),c=h}),d},g=function(a,b){this.v=a,this.board=b;var c=this.to_xy();this.y=c.y,this.x=c.x,this.neighbours={above:!1,below:!1,right:!1,left:!1},this.active=!0,this.matchable=!1,this.selected=!1,this.listener=this.get_callback(),b.tiles.push(this)};g.prototype.classes={selected:"tile__selected",matchable:"tile__good_match",hint:["tile__hint_1","tile__hint_2","tile__hint_3","tile__hint_4"],inactive:"tile__matched"},g.prototype.to_xy=function(){return c(this.board.tiles.length)},g.prototype.to_index=function(){return d(this.x,this.y)},g.prototype.deactivate=function(){this.active=!1;var a=this.neighbours.below;a&&(a.neighbours.above=!1);var b=this.neighbours.above;b&&(b.neighbours.below=!1);var c=this.neighbours.right;c&&(c.neighbours.left=!1);var d=this.neighbours.left;d&&(d.neighbours.right=!1),_.each(this.get_neighbours(),function(a){a.matchable=!1})},g.prototype.select=function(){this.selected=!0,_.each(this.get_matches(),function(a){a.matchable=!0})},g.prototype.deselect=function(){this.selected=!1,_.each(this.get_matches(),function(a){a.matchable=!1})},g.prototype.check_match=function(a){return a.v+this.v===b+1||a.v===this.v},g.prototype.get_neighbour=function(a,b){var c=this.to_index()+b;this.neighbours[a]&&(c=this.neighbours[a].to_index());for(var d=!0;d&&!d.active;)d=this.board.tiles[c],c+=b;return d?d:!1},g.prototype.set_neighbours=function(){this.neighbours.above=this.get_neighbour("above",-b),this.neighbours.below=this.get_neighbour("below",b),this.neighbours.right=this.get_neighbour("right",1),this.neighbours.left=this.get_neighbour("left",-1)},g.prototype.get_neighbours=function(){var a=[this.neighbours.above,this.neighbours.below,this.neighbours.left,this.neighbours.right];return a.filter(function(a){return a&&a.active})},g.prototype.get_matches=function(){if(!this.active)return[];var a=this,b=a.get_neighbours().filter(function(b){return a.check_match(b)});return b.filter(function(a,c){var d=b.filter(function(b,d){return d>=c?!1:a.x===b.x&&a.y===b.y});return 0===d.length})},g.prototype.update=function(){if(this.set_neighbours(),!this.active)return void(this.className=this.classes.inactive);if(this.selected)return void(this.className=this.classes.selected);if(this.matchable)return void(this.className=this.classes.matchable);var a=this.get_matches().length;return a>0?void(this.className=this.classes.hint[a-1]):void(this.className="")},g.prototype.serialize=function(){var a=this;return{x:a.x,y:a.y,v:a.v,active:a.active}},g.prototype.deserialize=function(a,b){_.extend(this,a),this.neighbours.above=!1,this.neighbours.below=!1,this.neighbours.left=!1,this.neighbours.right=!1,this.board=b,this.listener=this.get_callback()},g.prototype.get_callback=function(){var a=this,b=function(){var b=a.board.currently_selected;if(a.matchable){a.board.save(),a.board.steps++;var c=[a,b];_.invoke(c,"deactivate");var d=a.get_neighbours().concat(b.get_neighbours());return _.invoke(d.concat(c),"update"),void a.board.update()}var e=[];b&&(b.deselect(),e=b.get_neighbours().concat(b)),a.select(),_.invoke(a.get_neighbours().concat([a]).concat(e),"update"),a.board.currently_selected=a,a.board.update()},c=!1,d=function(a){c||(c=!0,setTimeout(function(){c=!1},200),b.bind(this)()),a.preventDefault()};return d};var h=function(){var c=this;this.tiles=[],this.steps=0,a.board=this,this.board_history=[],this.iterations=0,this.get_tile=function(a,b){return c.tiles[d(a,b)]},this.get_rows=function(){return e(this.tiles,function(a){return 0===a.x}).map(function(a){return{tiles:a,active:_.some(a,_.property("active"))}})},c.init=function(){_.each([0,1],function(a){_.each(_.range(b),function(b){var d=""+(10*a+b+1);_.each(_.range(d.length),function(a){new g(Number(d[a]),c)})})}),_.invoke(this.tiles,"update")},c.save=function(){this.board_history.push(_.invoke(this.tiles,"serialize")),this.board_history.length>100&&this.board_history.shift()},c.step_back=function(){if(0!==this.board_history.length){var a=this.board_history.pop();this.set_state(a),this.steps--}},this.set_state=function(a){a=a.map(function(a){var b=new g(0,c);return b.deserialize(a,c),b}),this.tiles=a,_.invoke(this.tiles,"update")},c.update=function(){if(0===this.active_tiles().length)return void window.alert("You won the game! Congrats!");if(0===this.left_matches().length){var a=this.active_tiles();_.each(a,function(a){new g(a.v,c)}),_.invoke(this.tiles,"update")}return this.iterations>=5?void window.alert("Oh no you lost!"):void(0===this.left_matches().length?(this.iterations++,this.update()):this.iterations=0)},c.active_tiles=function(){return c.tiles.filter(_.property("active"))},c.inactive_tiles=function(){return c.tiles.filter(function(a){return!a.active})},c.left_matches=function(){return _.flatten(_.invoke(this.active_tiles(),"get_matches"))},this.test_boards={infinite:[{x:0,y:0,v:1,active:!1},{x:1,y:0,v:2,active:!0},{x:2,y:0,v:3,active:!0},{x:3,y:0,v:1,active:!1},{x:4,y:0,v:1,active:!1},{x:5,y:0,v:1,active:!1},{x:6,y:0,v:1,active:!1},{x:7,y:0,v:1,active:!1},{x:8,y:0,v:1,active:!1},{x:0,y:1,v:1,active:!1},{x:1,y:1,v:2,active:!1},{x:2,y:1,v:3,active:!1},{x:3,y:1,v:1,active:!1},{x:4,y:1,v:1,active:!1},{x:5,y:1,v:1,active:!1},{x:6,y:1,v:1,active:!1},{x:7,y:1,v:4,active:!0},{x:8,y:1,v:4,active:!1},{x:0,y:2,v:1,active:!1},{x:1,y:2,v:2,active:!1},{x:2,y:2,v:3,active:!1},{x:3,y:2,v:1,active:!0},{x:4,y:2,v:1,active:!1},{x:5,y:2,v:1,active:!1},{x:6,y:2,v:1,active:!1},{x:7,y:2,v:1,active:!1},{x:8,y:2,v:4,active:!1},{x:0,y:3,v:1,active:!1},{x:1,y:3,v:2,active:!1},{x:2,y:3,v:3,active:!1},{x:3,y:3,v:4,active:!0},{x:4,y:3,v:1,active:!1},{x:5,y:3,v:1,active:!1},{x:6,y:3,v:1,active:!1},{x:7,y:3,v:1,active:!1},{x:8,y:3,v:4,active:!1},{x:0,y:4,v:1,active:!1},{x:1,y:4,v:2,active:!1},{x:2,y:4,v:3,active:!1},{x:3,y:4,v:1,active:!0},{x:4,y:4,v:1,active:!1},{x:5,y:4,v:1,active:!1},{x:6,y:4,v:1,active:!1},{x:7,y:4,v:1,active:!1},{x:8,y:4,v:4,active:!1},{x:0,y:5,v:1,active:!1},{x:1,y:5,v:2,active:!1},{x:2,y:5,v:5,active:!0},{x:3,y:5,v:1,active:!1},{x:4,y:5,v:5,active:!0},{x:5,y:5,v:1,active:!1},{x:6,y:5,v:1,active:!1},{x:7,y:5,v:7,active:!0},{x:8,y:5,v:1,active:!0},{x:0,y:6,v:8,active:!0},{x:1,y:6,v:1,active:!0}]},c.init()},i=function(b){this.toggle_pilot=function(){this.pilot_running=!this.pilot_running;var b=this,c=function(){var d=[];_.each(a.board.active_tiles(),function(a){var b=a.get_matches();d=d.concat(b)});var e=[];_.each(["tile__hint_1","tile__hint_2","tile__hint_3","tile__hint_4"],function(a){var b=[].slice.call(document.getElementsByClassName(a));e=e.concat(b)});var f=e[_.random(0,e.length-1)];f&&f.click(),setTimeout(function(){var a=document.getElementsByClassName("tile__good_match"),d=a[_.random(a.length-1)];d.click(),b.pilot_running&&c()},100)};c()},this.run=function(){this.react=new j,React.render(this.react,b)}},j=React.createFactory(React.createClass({displayName:"Game",getInitialState:function(){return{board:new h(b)}},restartGame:function(){this.setState(this.getInitialState())},stepBack:function(){var a=this;a.state.board.step_back(),this.setState({board:a.state.board})},render:function(){var a=this;return React.createElement("div",{},[React.createElement("div",{className:"header",key:"header"},React.createElement("div",{className:"buttons"},[React.createElement("div",{className:"score",key:"score"},React.createElement("div",{className:"small"},"steps"),a.state.board.steps),React.createElement("div",{className:"new",key:"new",onClick:a.restartGame},"New Game"),React.createElement("div",{className:"new",key:"back",onClick:a.stepBack},"Back")])),React.createElement("div",{className:"board",key:"board"},new k({board:a.state.board,game:a}))])}})),k=React.createFactory(React.createClass({displayName:"Board",render:function(){var a=this,b=a.props.board.get_rows(),c=f(b,_.property("active")),d=c.map(function(b,c){var d=[b.map(function(b,c){return new l({row:b,key:c,game:a.props.game})})];return b.length>1&&!b[0].active&&d.push(React.createElement("div",{className:"tile_row__button",key:"button"},b.length)),React.createElement("div",{className:"tile_row__lines",key:c},d)});return React.createElement("div",{className:"table"},d)}})),l=React.createFactory(React.createClass({displayName:"Row",shouldComponentUpdate:function(){return this.props.row.active},render:function(){var a=this,b=this.props.row.tiles.map(function(b,c){return new m({tile:b,key:c,game:a.props.game})});return React.createElement("div",{className:"tile_row"+(a.props.row.active?"":" tile_row__hidden")},b)}})),m=React.createFactory(React.createClass({displayName:"Tile",render:function(){var a=this,b=function(b){a.props.tile.listener.bind(this)(b),a.props.game.setState(a.props.tile.board)};b=a.props.tile.get_matches().length>0?b:null;var c={className:["tile",a.props.tile.className].join(" ")};return b&&(c.onTouchStart=b,c.onClick=b),React.createElement("div",{className:"tile_cell"},React.createElement("div",c,a.props.tile.v))}})),n=new i(document.getElementById("react"));n.run(),a.game=n}();