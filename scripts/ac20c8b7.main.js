"use strict";!function(){var a=window.caro_game||{};window.caro_game=a;var b=9,c=function(a){return{y:Math.floor(a/b),x:a%b}},d=function(a,c){return c*b+a},e=function(a,b){var c,d=[],e=[];return _.each(a,function(f,g){var h=b(f);h===c||0===g?e.push(f):(d.push(e),e=[f]),g===a.length-1&&d.push(e),c=h}),d},f=function(a,b){for(var c=-1,d=a?a.length:0;++c<d&&b(a[c]););return a.splice(c,a.length)},g=function(a,b){this.v=a,this.board=b;var c=this.to_xy();this.y=c.y,this.x=c.x,this.neighbours={above:!1,below:!1,right:!1,left:!1},this.set_neighbours(),this.active=!0,b.tiles.push(this)};g.prototype.to_xy=function(){return c(this.board.tiles.length)},g.prototype.to_index=function(){return d(this.x,this.y)},g.prototype.activate=function(){this.dom.bind("touchstart click",this.listener)},g.prototype.deactivate=function(){this.active=!1,this.dom.unbind("touchstart click")},g.prototype.check_match=function(a){return a.v+this.v===b+1||a.v===this.v},g.prototype.set_above=function(){for(var a=this.x,b=this.y-1,c=!0;c&&!c.active;)c=this.board.get_tile(a,b),b--;c?(this.neighbours.above=c,c.neighbours.below=this):this.neighbours.above=!1},g.prototype.set_below=function(){for(var a=this.x,b=this.y+1,c=!0;c&&!c.active;)c=this.board.get_tile(a,b),b++;c?(this.neighbours.below=c,c.neighbours.above=this):this.neighbours.below=!1},g.prototype.set_right=function(){for(var a=this.to_index()+1,b=!0;b&&!b.active;)b=this.board.tiles[a],a++;b?(this.neighbours.right=b,b.neighbours.left=this):this.neighbours.right=!1},g.prototype.set_left=function(){for(var a=this.to_index()-1,b=!0;b&&!b.active;)b=this.board.tiles[a],a--;b?(this.neighbours.left=b,b.neighbours.right=this):this.neighbours.left=!1},g.prototype.set_neighbours=function(){this.set_above(),this.set_below(),this.set_right(),this.set_left()},g.prototype.get_neighbours=function(){var a=[this.neighbours.above,this.neighbours.below,this.neighbours.left,this.neighbours.right];return a.filter(function(a){return a&&a.active})},g.prototype.get_matches=function(){var a=this;return a.get_neighbours().filter(function(b){return a.check_match(b)})};var h=function(a){var b=this;this.columns=a,this.tiles=[],this.get_tile=function(a,c){return b.tiles[d(a,c)]},b.init=function(){_.each([0,1],function(a){_.each(_.range(b.columns),function(c){var d=""+(10*a+c+1);_.each(_.range(d.length),function(a){new g(Number(d[a]),b)})})})},b.update=function(){var a=this.active_tiles();_.each(a,function(a){new g(a.v,b)})},b.active_tiles=function(){return b.tiles.filter(_.property("active"))},b.inactive_tiles=function(){return b.tiles.filter(function(a){return!a.active})},b.left_matches=function(){var a=[];return _.each(this.active_tiles(),function(b){var c=b.get_matches();a=a.concat(c)}),a},b.init()},i=function(a){var c=this;this.board=new h(b),this.root=a;var d=$("#score_number"),g=$("#new_game"),i=0,j=function(a){return a.removeClass("tile__hint_1 tile__hint_2 tile__hint3 tile__hint_4 tile__selected tile__good_match tile__bad_match")};this.draw_tile=function(a,b){var e=$("<div></div>").addClass("tile_cell");b.dom=$("<div></div>"),b.dom_parent=a,e.append(b.dom),a.append(e),b.dom.addClass("tile").html(b.v),b.active||b.dom.addClass("tile__matched");var f=function(){if(b.dom.hasClass("tile__good_match"))return i++,d.html(i),c.currently_selected.dom.addClass("tile__matched"),b.dom.addClass("tile__matched"),b.deactivate(),c.currently_selected.deactivate(),_.each(c.board.active_tiles(),function(a){a.set_neighbours()}),j($(".tile")),void c.update();j($(".tile")),b.dom.addClass("tile__selected");var a=b.get_matches();_.each(a,function(a){a.dom.addClass("tile__good_match")}),c.currently_selected=b,c.update()},g=!1,h=function(){return g||(g=!0,setTimeout(function(){g=!1},200),f.bind(this)()),!1};b.listener=h},this.draw_board=function(){var a=c.board.tiles.filter(function(a){return!a.dom}),b=c.board.tiles.filter(function(a){return a.dom});c.table||(c.table=$("<div></div>").addClass("table"),c.root.append(c.table));var d,e;_.each(a,function(a){if(b.length&&!e&&(d=_.last(b).dom_parent,e=!0),0===a.x){var f;f||(f=$("<div></div>").addClass("tile_row"),c.table.append(f)),d=f}c.draw_tile(d,a)})},this.update=function(){var a=[];_.each(this.board.active_tiles(),function(b){var c=b.get_matches();a=a.concat(c),c.length>0&&(b.activate(),b.dom.removeClass("tile__hint_1 tile__hint_2 tile__hint3 tile__hint_4"),b.dom.addClass("tile__hint_"+c.length))});var c=e(this.board.tiles,_.property("active")),d=1,g=c.filter(function(a){return!a[0].active}).filter(function(a){return a.length>d*b}).map(function(a){var c=f(a,function(a){return 0!==a.x}),d=_.clone(c).reverse();return c=f(d,function(a){return a.x!==b-1}),c.reverse()}).filter(function(a){return a.length>d*b});return _.each(g,function(a){var c,d=a.length/b;if(_.each(a,function(a){a.dom_parent_parent&&(c&&!c.is(a.dom_parent_parent)?(c.append(a.dom_parent_parent.children()),c.dom_parent_parent&&!c.dom_parent_parent.children().length&&a.dom_parent_parent.remove()):c=a.dom_parent_parent)}),!c){c=$("<div></div>").addClass("tile_row__lines");var e=$("<div></div>").addClass("tile_row__button").html(d);c.append(e),a[0].dom_parent.before(c)}_.each(a,function(a){0!==a.x||a.is_hidden||(a.dom_parent.addClass("tile_row__hidden"),c.append(a.dom_parent),a.is_hidden=!0,a.dom_parent_parent=c)}),c.find(".tile_row__button").html(d)}),0===this.board.active_tiles().length?void window.alert("You won the game! Congrats!"):void(0===a.length&&(this.board.update(),this.draw_board(),this.update()))},this.run=function(){this.board=new h(b),this.draw_board(),this.update()},this.restart=function(){d.html(0),i=0,c.table.html(""),c.run()},this.win=function(){_.each(this.board.tiles,function(a){a.deactivate()}),this.update()},this.auto_pilot=function(){var a=this,b=[];_.each(this.board.active_tiles(),function(a){var c=a.get_matches();b=b.concat(c)});var c=b[_.random(b.length-1)];c.dom.click(),setTimeout(function(){var b=$(".tile__good_match"),c=$(b[_.random(b.length-1)]);c.click(),a.stop_the_pilot||a.auto_pilot()},200)},this.stop_pilot=function(){this.stop_the_pilot=!0},g.bind("click",this.restart)},j=$("#game"),k=new i(j);k.run(),a.game=k}();