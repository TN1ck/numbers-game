"use strict";!function(){var a=window.caro_game||{};window.caro_game=a;var b=9,c=function(a){return{y:Math.floor(a/b),x:a%b}},d=function(a,c){return c*b+a},e=function(a,b){var c,d=[],e=[];return _.each(a,function(f,g){var h=b(f);h===c||0===g?e.push(f):(d.push(e),e=[f]),g===a.length-1&&d.push(e),c=h}),d},f=function(a,b){for(var c=-1,d=a?a.length:0;++c<d&&b(a[c]););return a.splice(c,a.length)},g=function(a,b){this.v=a,this.board=b;var c=this.to_xy();this.y=c.y,this.x=c.x,this.neighbours={above:!1,below:!1,right:!1,left:!1},this.set_neighbours(),this.active=!0,this.matchable=!1,this.selecetd=!1,b.tiles.push(this)};g.prototype.classes={selected:"tile__selected",matchable:"tile__good_match",hint:["tile__hint_1","tile__hint_2","tile__hint_3","tile__hint_4"],inactive:"tile__matched"},g.prototype.to_xy=function(){return c(this.board.tiles.length)},g.prototype.to_index=function(){return d(this.x,this.y)},g.prototype.bind_listener=function(){this.dom.bind("touchstart click",this.listener)},g.prototype.unbind_listener=function(){this.dom.unbind("touchstart click")},g.prototype.deactivate=function(){this.active=!1;var a=this.neighbours.below;a&&(a.neighbours.above=!1);var b=this.neighbours.above;b&&(b.neighbours.below=!1);var c=this.neighbours.right;c&&(c.neighbours.left=!1);var d=this.neighbours.left;d&&(d.neighbours.right=!1),_.each(this.get_neighbours(),function(a){a.matchable=!1}),this.unbind_listener()},g.prototype.select=function(){this.selected=!0,_.each(this.get_matches(),function(a){a.matchable=!0})},g.prototype.deselect=function(){this.selected=!1,_.each(this.get_matches(),function(a){a.matchable=!1})},g.prototype.check_match=function(a){return a.v+this.v===b+1||a.v===this.v},g.prototype.set_above=function(){var a,b;this.neighbours.above?(a=this.neighbours.above.x,b=this.neighbours.above.y):(a=this.x,b=this.y-1);for(var c=!0;c&&!c.active;)c=this.board.get_tile(a,b),b--;c?(this.neighbours.above=c,c.neighbours.below=this):this.neighbours.above=!1},g.prototype.set_below=function(){var a,b;this.neighbours.below?(a=this.neighbours.below.x,b=this.neighbours.below.y):(a=this.x,b=this.y+1);for(var c=!0;c&&!c.active;)c=this.board.get_tile(a,b),b++;c?(this.neighbours.below=c,c.neighbours.above=this):this.neighbours.below=!1},g.prototype.set_right=function(){var a;a=this.neighbours.right?this.neighbours.right.to_index():this.to_index()+1;for(var b=!0;b&&!b.active;)b=this.board.tiles[a],a++;b?(this.neighbours.right=b,b.neighbours.left=this):this.neighbours.right=!1},g.prototype.set_left=function(){var a;a=this.neighbours.left?this.neighbours.left.to_index():this.to_index()-1;for(var b=!0;b&&!b.active;)b=this.board.tiles[a],a--;b?(this.neighbours.left=b,b.neighbours.right=this):this.neighbours.left=!1},g.prototype.set_neighbours=function(){this.set_above(),this.set_below(),this.set_right(),this.set_left()},g.prototype.get_neighbours=function(){var a=[this.neighbours.above,this.neighbours.below,this.neighbours.left,this.neighbours.right];return a.filter(function(a){return a&&a.active})},g.prototype.get_matches=function(){var a=this;return a.get_neighbours().filter(function(b){return a.check_match(b)})},g.prototype.setClass=function(){if(!this.active)return void(this.className=this.classes.inactive);if(this.selected)return void(this.className=this.classes.selected);if(this.matchable)return void(this.className=this.classes.matchable);var a=this.get_matches().length;return a>0?void(this.className=this.classes.hint[a-1]):void(this.className="")},g.prototype.update_dom=function(){this.setClass(),this.get_matches().length?this.bind_listener():this.unbind_listener(),this.dom.attr("class","tile "+this.className)};var h=function(a){var b=this;this.columns=a,this.tiles=[],this.get_tile=function(a,c){return b.tiles[d(a,c)]},b.init=function(){_.each([0,1],function(a){_.each(_.range(b.columns),function(c){var d=""+(10*a+c+1);_.each(_.range(d.length),function(a){new g(Number(d[a]),b)})})})},b.update=function(){var a=this.active_tiles();_.each(a,function(a){new g(a.v,b)}),_.invoke(a,"update_dom")},b.active_tiles=function(){return b.tiles.filter(_.property("active"))},b.inactive_tiles=function(){return b.tiles.filter(function(a){return!a.active})},b.left_matches=function(){var a=[];return _.each(this.active_tiles(),function(b){var c=b.get_matches();a=a.concat(c)}),a},b.init()},i=function(a){var c=this;this.board=new h(b),this.root=a;var d=$("#score_number"),g=$("#new_game"),i=0;this.draw_tile=function(a,b){var e=$("<div></div>").addClass("tile_cell");b.dom=$("<div></div>"),b.dom_parent=a,e.append(b.dom),a.append(e),b.dom.addClass("tile").html(b.v),b.active||b.dom.addClass("tile__matched");var f=function(){if(b.matchable){i++,d.html(i);var a=[b,c.currently_selected];_.invoke(a,"deactivate");var e=b.get_neighbours().concat(c.currently_selected.get_neighbours());return _.invoke(e,"set_neighbours"),_.invoke(e.concat(a),"update_dom"),void c.update()}var f=[];c.currently_selected&&(c.currently_selected.deselect(),f=c.currently_selected.get_neighbours().concat(c.currently_selected)),b.select(),_.invoke(b.get_neighbours().concat([b]).concat(f),"update_dom"),c.currently_selected=b,c.update()},g=!1,h=function(){return g||(g=!0,setTimeout(function(){g=!1},200),f.bind(this)()),!1};b.listener=h,b.update_dom()},this.draw_board=function(){var a=c.board.tiles.filter(function(a){return!a.dom}),b=c.board.tiles.filter(function(a){return a.dom});c.table||(c.table=$("<div></div>").addClass("table"),c.root.append(c.table));var d,e;_.each(a,function(a){if(b.length&&!e&&(d=_.last(b).dom_parent,e=!0),0===a.x){var f;f||(f=$("<div></div>").addClass("tile_row"),c.table.append(f)),d=f}c.draw_tile(d,a)})},this.update=function(){var a=[];_.each(this.board.active_tiles(),function(b){var c=b.get_matches();a=a.concat(c)});var c=e(this.board.tiles,_.property("active")),d=1,g=c.filter(function(a){return!a[0].active}).filter(function(a){return a.length>d*b}).map(function(a){var c=f(a,function(a){return 0!==a.x}),d=_.clone(c).reverse();return c=f(d,function(a){return a.x!==b-1}),c.reverse()}).filter(function(a){return a.length>d*b});return _.each(g,function(a){var c,d=a.length/b;if(_.each(a,function(a){a.dom_parent_parent&&(c&&!c.is(a.dom_parent_parent)?(c.append(a.dom_parent_parent.children()),c.dom_parent_parent&&!c.dom_parent_parent.children().length&&a.dom_parent_parent.remove()):c=a.dom_parent_parent)}),!c){c=$("<div></div>").addClass("tile_row__lines");var e=$("<div></div>").addClass("tile_row__button").html(d);c.append(e),a[0].dom_parent.before(c)}_.each(a,function(a){0!==a.x||a.is_hidden||(a.dom_parent.addClass("tile_row__hidden"),c.append(a.dom_parent),a.is_hidden=!0,a.dom_parent_parent=c)}),c.find(".tile_row__button").html(d)}),0===this.board.active_tiles().length?void window.alert("You won the game! Congrats!"):void(0===a.length&&(this.board.update(),this.draw_board(),this.update()))},this.run=function(){this.board=new h(b),this.draw_board(),this.update()},this.restart=function(){d.html(0),i=0,c.table.html(""),c.run()},this.win=function(){_.each(this.board.tiles,function(a){a.deactivate(),a.update_dom()}),this.update()},this.pilot_running=!1,this.toggle_pilot=function(){this.pilot_running=!this.pilot_running;var a=this,b=function(){var c=[];_.each(a.board.active_tiles(),function(a){var b=a.get_matches();c=c.concat(b)});var d=c[_.random(c.length-1)];d.dom.click(),setTimeout(function(){var c=$(".tile__good_match"),d=$(c[_.random(c.length-1)]);d.click(),a.pilot_running&&b()},5)};b()},g.bind("click",this.restart)},j=$("#game"),k=new i(j);k.run(),a.game=k}();